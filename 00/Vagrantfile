# -*- mode: ruby -*-
# vi: set ft=ruby : 

require_relative 'vagrant_credentials.rb'
include Secrets

Vagrant.configure("2") do |config|
  config.vm.box = "centos/8"
  # config.vm.synced_folder "./shared", "/home/vagrant/1"
    config.vm.define "Server" do |config|
    config.vm.hostname = "Server"
    config.vm.network :private_network, ip: "192.168.42.111"
    config.vm.provider "virtualbox" do |vb|
      vb.gui = false
      vb.memory = "2048"
      vb.cpus = 2
      vb.name = "Server"
      config.vm.provision "shell", inline: <<-SHELL
        sudo -s
        ssh-keygen -f /root/.ssh/id_rsa -t rsa -N ''
        cd /etc/yum.repos.d/
        sed -i 's/mirrorlist/#mirrorlist/g' /etc/yum.repos.d/CentOS-*
        sed -i 's|#baseurl=http://mirror.centos.org|baseurl=http://vault.centos.org|g' /etc/yum.repos.d/CentOS-*
        dnf update -y
        cd /home/vagrant
        dnf update -y && dnf install wget vim net-tools git lsof tar -y
        # wget https://archives.fedoraproject.org/pub/archive/epel/6/x86_64/epel-release-6-8.noarch.rpm
        # rpm -ivh epel-release-6-8.noarch.rpm
        # yum --enablerepo=epel -y install sshpass
        sed -i 's/enforcing/disabled/g' /etc/selinux/config
        sed -i 's/PasswordAuthentication\s.*no/PasswordAuthentication yes/g' /etc/ssh/sshd_config
        systemctl disable firewalld
        systemctl restart sshd
      SHELL
      config.vm.provision :shell do |shell|
        shell.inline = "echo root:$1 | chpasswd"
        # shell.inline = " echo root:$1 | chpasswd; sshpass -p $1 ssh-copy-id  -o StrictHostKeyChecking=no root@192.168.42.111"
        shell.args = Password
      end
      config.vm.provision :reload
      config.vm.provision "shell", inline: <<-SHELL
        curl -sfL https://get.k3s.io | sh -s - --write-kubeconfig-mode 644
        systemctl status k3s
      SHELL
    end
  end
  config.vm.define "ServerWorker" do |config|
    config.vm.hostname = "ServerWorker"
    config.vm.network :private_network, ip: "192.168.42.110"
    config.vm.provider "virtualbox" do |vb|
      vb.gui = false
      vb.name = "ServerWorker"
      vb.memory = "2048"
      vb.cpus = 2
      config.vm.provision "shell", inline: <<-SHELL
        sudo -s
        ssh-keygen -f /root/.ssh/id_rsa -t rsa -N ''
        cd /etc/yum.repos.d/
        sed -i 's/mirrorlist/#mirrorlist/g' /etc/yum.repos.d/CentOS-*
        sed -i 's|#baseurl=http://mirror.centos.org|baseurl=http://vault.centos.org|g' /etc/yum.repos.d/CentOS-*
        dnf update -y
        cd /home/vagrant
        dnf update -y && dnf install vim wget net-tools git lsof tar -y
        wget https://archives.fedoraproject.org/pub/archive/epel/6/x86_64/epel-release-6-8.noarch.rpm
        rpm -ivh epel-release-6-8.noarch.rpm
        yum --enablerepo=epel -y install sshpass
        sed -i 's/enforcing/disabled/g' /etc/selinux/config
        sed -i 's/PasswordAuthentication\s.*no/PasswordAuthentication yes/g' /etc/ssh/sshd_config
        systemctl disable firewalld
        systemctl restart sshd
      SHELL
      config.vm.provision :reload
      config.vm.provision :shell do |shell|
        # shell.inline = "echo root:$1 | chpasswd"
        shell.inline = "echo $1 > pass.txt; echo root:$1 | chpasswd"
        shell.args = Password
      end
      config.vm.provision :shell do |shell|
        # shell.inline = "echo root:$1 | chpasswd"
        shell.inline = " echo root:$1 | chpasswd; sshpass -p $1 ssh-copy-id  -o StrictHostKeyChecking=no root@192.168.42.111"
        shell.args = Password
      config.vm.provision "shell", inline: <<-SHELL
        scp  root@192.168.42.111://var/lib/rancher/k3s/server/node-token ./
        token=`cat node-token`
        curl -sfL https://get.k3s.io | K3S_URL=https://192.168.42.111:6443 K3S_TOKEN=$token sh -
        systemctl status k3s-agent
      SHELL
      end
    end
  end
end
